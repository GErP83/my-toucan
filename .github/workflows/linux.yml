name: Build, Test and Upload Linux Binaries for tag

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      run_rpm:
        required: false
        type: boolean
        default: true
      run_deb:
        required: false
        type: boolean
        default: true
      static_stdlib:
        required: false
        type: boolean
        default: true

jobs:
  precheck:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - id: check
        run: |
          if [[ "${{ inputs.run_rpm }}" == "true" || "${{ inputs.run_deb }}" == "true" ]]; then
            echo "‚úÖ Packaging enabled"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "üö´ No packaging format selected"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  build-binaries:
    needs: precheck
    if: needs.precheck.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        #arch: [arm64]
        arch: [x86_64, arm64]
    name: Build ${{ matrix.arch }}
    container:
      image: swift:6.0
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          chmod +x ./scripts/packaging/*.sh
          apt-get update
          apt-get install -y curl git clang libcurl4-openssl-dev libssl-dev libatomic1 zip rpm dpkg-dev qemu-user-static

      - name: Build binaries
        run: |
          if [[ "${{ inputs.static_stdlib }}" == "true" ]]; then
            echo "üîß Building with static Swift stdlib for ${{ matrix.arch }}"
            swift build -c release -Xswiftc -static-stdlib
          else
            echo "üîß Building without static Swift stdlib for ${{ matrix.arch }}"
            swift build -c release
          fi

      - name: Package RPM
        if: inputs.run_rpm
        run: |
          ARCH=${{ matrix.arch == 'arm64' && 'aarch64' || 'x86_64' }}
          ./scripts/packaging/rpm.sh ${{ inputs.version }} $ARCH

      - name: Package DEB
        if: inputs.run_deb
        run: |
          ARCH=${{ matrix.arch == 'arm64' && 'arm64' || 'amd64' }}
          ./scripts/packaging/deb.sh ${{ inputs.version }} $ARCH

      - name: Create Linux ZIP and SHA256
        run: |
          set -e
          ARCH=${{ matrix.arch }}
          VERSION=${{ env.BUILD_VERSION }}

          echo "üì¶ Creating Linux ZIP for $ARCH (version: ${VERSION:-unknown})"
          mkdir -p build-zip

          for BIN in toucan toucan-generate toucan-init toucan-serve toucan-watch; do
            if [ -f ".build/release/$BIN" ]; then
              cp ".build/release/$BIN" build-zip/
              echo "‚úÖ Added $BIN"
            else
              echo "‚ö†Ô∏è Missing binary: $BIN"
            fi
          done

          echo " Contents of build-zip/"
          ls -lh build-zip

          cd build-zip
          zip -r "../toucan-linux-$ARCH-${VERSION}.zip" ./*
          cd - >/dev/null

          sha256sum "toucan-linux-$ARCH-${VERSION}.zip" > "toucan-linux-$ARCH-${VERSION}.sha256"
          echo "‚úÖ ZIP + SHA created"
          

      - name: Upload Linux artifacts
        if: inputs.run_rpm || inputs.run_deb
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts-${{ matrix.arch }}
          retention-days: 1
          path: |
            ${{ inputs.run_rpm && format('build-rpm/toucan-linux-{0}-{1}.rpm', matrix.arch, inputs.version) || '' }}
            ${{ inputs.run_deb && format('build-deb/toucan-linux-{0}-{1}.deb', matrix.arch, inputs.version) || '' }}
            ${{ inputs.run_rpm && format('build-zip/toucan-linux-{0}-{1}.zip', matrix.arch, inputs.version) || '' }}

  test-and-upload:
  runs-on: ubuntu-latest
  needs: build-binaries
  strategy:
    matrix:
      arch: [x86_64, arm64]
  steps:
    # 1Ô∏è‚É£ Download artifacts from the build job
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: linux-artifacts-${{ matrix.arch }}
        path: ./packages

    # 2Ô∏è‚É£ List downloaded structure for debugging
    - name: Check unpacked structure
      run: find packages -type f

    # ------------------------------------------------------------
    # 3Ô∏è‚É£ Test RPM in Fedora ‚Üí Upload RPM
    # ------------------------------------------------------------
    - name: Test RPM in Fedora
      if: inputs.run_rpm
      run: |
        echo "üß™ Testing RPM for ${{ matrix.arch }}"
        docker run --rm -v "$PWD/packages:/packages" fedora \
          bash -c "dnf install -y /packages/build-rpm/toucan-linux-${{ matrix.arch }}-${{ inputs.version }}.rpm && toucan --version"
        echo "‚úÖ RPM test passed"

    - name: Upload RPM binary to release
      if: inputs.run_rpm
      uses: AButler/upload-release-assets@v3.0
      with:
        files: packages/build-rpm/toucan-linux-${{ matrix.arch }}-${{ inputs.version }}.rpm
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        release-tag: ${{ github.ref_name }}

    # ------------------------------------------------------------
    # 4Ô∏è‚É£ Test ZIP integrity ‚Üí Upload ZIP
    # ------------------------------------------------------------
    - name: Test ZIP integrity
      if: inputs.run_rpm
      run: |
        echo "üß™ Verifying ZIP for ${{ matrix.arch }}"
        unzip -t packages/build-zip/toucan-linux-${{ matrix.arch }}-${{ inputs.version }}.zip
        echo "‚úÖ ZIP verified successfully"

    - name: Upload Linux ZIP
      if: inputs.run_rpm
      uses: AButler/upload-release-assets@v3.0
      with:
        files: packages/build-zip/toucan-linux-${{ matrix.arch }}-${{ inputs.version }}.zip
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        release-tag: ${{ github.ref_name }}

    # ------------------------------------------------------------
    # 5Ô∏è‚É£ Test DEB in Ubuntu ‚Üí Upload DEB
    # ------------------------------------------------------------
    - name: Test DEB in Ubuntu
      if: inputs.run_deb
      run: |
        echo "üß™ Testing DEB for ${{ matrix.arch }}"
        docker run --rm -v "$PWD/packages:/packages" ubuntu \
          bash -c '
            apt-get update &&
            apt-get install -y curl &&
            dpkg -i /packages/build-deb/toucan-linux-${{ matrix.arch }}-${{ inputs.version }}.deb || apt-get install -f -y &&
            toucan --version
          '
        echo "‚úÖ DEB test passed"

    - name: Upload DEB binary to release
      if: inputs.run_deb
      uses: AButler/upload-release-assets@v3.0
      with:
        files: packages/build-deb/toucan-linux-${{ matrix.arch }}-${{ inputs.version }}.deb
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        release-tag: ${{ github.ref_name }}

    # ------------------------------------------------------------
    # 6Ô∏è‚É£ Upload combined SHA256SUMS file (once)
    # ------------------------------------------------------------
    - name: Upload combined SHA256SUMS.txt
      if: matrix.arch == 'x86_64'  # only once to avoid duplicates
      uses: AButler/upload-release-assets@v3.0
      with:
        files: packages/toucan-${{ inputs.version }}-SHA256SUMS.txt
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        release-tag: ${{ github.ref_name }}