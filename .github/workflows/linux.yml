name: Build, Test and Upload Linux Binaries for tag

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      run_rpm:
        required: false
        type: boolean
        default: true
      run_deb:
        required: false
        type: boolean
        default: true
      static_stdlib:
        required: false
        type: boolean
        default: true

jobs:
  precheck:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - id: check
        run: |
          if [[ "${{ inputs.run_rpm }}" == "true" || "${{ inputs.run_deb }}" == "true" ]]; then
            echo "âœ… Packaging enabled"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸš« No packaging format selected"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  build-binaries:
    needs: precheck
    if: needs.precheck.outputs.should_run == 'true'
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm64
    runs-on: ${{ matrix.runner }}
    name: Build ${{ matrix.arch }}
    container:
      image: swift:6.0
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          chmod +x ./scripts/packaging/*.sh
          apt-get update
          apt-get install -y curl git clang libcurl4-openssl-dev libssl-dev libatomic1 zip rpm dpkg-dev qemu-user-static

      - name: Build binaries
        run: |
          if [[ "${{ inputs.static_stdlib }}" == "true" ]]; then
            echo "ðŸ”§ Building with static Swift stdlib for ${{ matrix.arch }}"
            swift build -c release -Xswiftc -static-stdlib
          else
            echo "ðŸ”§ Building without static Swift stdlib for ${{ matrix.arch }}"
            swift build -c release
          fi

      - name: Package RPM
        if: inputs.run_rpm
        run: |
          ARCH=${{ matrix.arch == 'arm64' && 'aarch64' || 'x86_64' }}
          ./scripts/packaging/rpm.sh ${{ inputs.version }} $ARCH

      - name: Package DEB
        if: inputs.run_deb
        run: |
          ARCH=${{ matrix.arch == 'arm64' && 'arm64' || 'amd64' }}
          ./scripts/packaging/deb.sh ${{ inputs.version }} $ARCH

      - name: Create ZIP file
        run: |
          set -e
          ARCH=${{ matrix.arch }}
          VERSION=${{ inputs.version }}

          echo "ðŸ“¦ Creating ZIP for $ARCH (version: ${VERSION})"
          mkdir -p build-zip

          for BIN in toucan toucan-generate toucan-init toucan-serve toucan-watch; do
            if [ -f ".build/release/$BIN" ]; then
              cp ".build/release/$BIN" build-zip/
              echo "âœ… Added $BIN"
            else
              echo "âš ï¸ Missing binary: $BIN"
            fi
          done

          echo " Contents of build-zip/"
          ls -lh build-zip

          cd build-zip
          zip -r "../toucan-linux-$ARCH-${VERSION}.zip" ./*
          cd - >/dev/null

          echo "âœ… ZIP created"

      - name: Upload RPM to artifacts
        if: inputs.run_rpm
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts-${{ matrix.arch }}-rpm
          path: build-rpm/toucan-linux-${{ matrix.arch }}-${{ inputs.version }}.rpm

      - name: Upload DEB to artifacts
        if: inputs.run_deb
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts-${{ matrix.arch }}-deb
          path: build-deb/toucan-linux-${{ matrix.arch }}-${{ inputs.version }}.deb

      - name: Upload ZIP to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts-${{ matrix.arch }}-zip
          path: build-zip/toucan-linux-${{ matrix.arch }}-${{ inputs.version }}.zip    

      
  test-and-upload:
    runs-on: ubuntu-latest
    needs: build-binaries
    steps:
      # 1ï¸âƒ£ Download all artifacts
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: linux-artifacts-*
          merge-multiple: true
          path: ./packages

      # 2ï¸âƒ£ List downloaded structure
      - name: Check unpacked structure
        run: find packages -type f

      # ------------------------------------------------------------
      # 3ï¸âƒ£ Test & Upload RPMs
      # ------------------------------------------------------------
      - name: Test RPM x86_64
        if: inputs.run_rpm
        run: |
          echo "ðŸ§ª Testing RPM x86_64..."
          docker run --rm -v "$PWD/packages:/packages" fedora \
            bash -c "dnf install -y /packages/build-rpm/toucan-linux-x86_64-${{ inputs.version }}.rpm && toucan --version"
          echo "âœ… RPM x86_64 passed"

      - name: Upload RPM x86_64
        if: inputs.run_rpm
        uses: AButler/upload-release-assets@v3.0
        with:
          files: packages/build-rpm/toucan-linux-x86_64-${{ inputs.version }}.rpm
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          release-tag: ${{ github.ref_name }}

      - name: Test RPM arm64
        if: inputs.run_rpm
        run: |
          echo "ðŸ§ª Testing RPM arm64..."
          docker run --rm -v "$PWD/packages:/packages" fedora \
            bash -c "dnf install -y /packages/build-rpm/toucan-linux-arm64-${{ inputs.version }}.rpm && toucan --version"
          echo "âœ… RPM arm64 passed"

      - name: Upload RPM arm64
        if: inputs.run_rpm
        uses: AButler/upload-release-assets@v3.0
        with:
          files: packages/build-rpm/toucan-linux-arm64-${{ inputs.version }}.rpm
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          release-tag: ${{ github.ref_name }}

      # ------------------------------------------------------------
      # 4ï¸âƒ£ Test & Upload DEBs
      # ------------------------------------------------------------
      - name: Test DEB x86_64
        if: inputs.run_deb
        run: |
          echo "ðŸ§ª Testing DEB x86_64..."
          docker run --rm -v "$PWD/packages:/packages" ubuntu \
            bash -c "
              apt-get update &&
              apt-get install -y curl &&
              dpkg -i /packages/build-deb/toucan-linux-x86_64-${{ inputs.version }}.deb || apt-get install -f -y &&
              toucan --version
            "
          echo "âœ… DEB x86_64 passed"

      - name: Upload DEB x86_64
        if: inputs.run_deb
        uses: AButler/upload-release-assets@v3.0
        with:
          files: packages/build-deb/toucan-linux-x86_64-${{ inputs.version }}.deb
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          release-tag: ${{ github.ref_name }}

      - name: Test DEB arm64
        if: inputs.run_deb
        run: |
          echo "ðŸ§ª Testing DEB arm64..."
          docker run --rm -v "$PWD/packages:/packages" ubuntu \
            bash -c "
              apt-get update &&
              apt-get install -y curl qemu-user-static &&
              dpkg -i /packages/build-deb/toucan-linux-arm64-${{ inputs.version }}.deb || apt-get install -f -y &&
              toucan --version
            "
          echo "âœ… DEB arm64 passed"

      - name: Upload DEB arm64
        if: inputs.run_deb
        uses: AButler/upload-release-assets@v3.0
        with:
          files: packages/build-deb/toucan-linux-arm64-${{ inputs.version }}.deb
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          release-tag: ${{ github.ref_name }}

      # ------------------------------------------------------------
      # 5ï¸âƒ£ Upload ZIPs (no test needed, one by one)
      # ------------------------------------------------------------
      - name: Upload ZIP x86_64
        uses: AButler/upload-release-assets@v3.0
        with:
          files: packages/build-zip/toucan-linux-x86_64-${{ inputs.version }}.zip
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          release-tag: ${{ github.ref_name }}

      - name: Upload ZIP arm64
        uses: AButler/upload-release-assets@v3.0
        with:
          files: packages/build-zip/toucan-linux-arm64-${{ inputs.version }}.zip
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          release-tag: ${{ github.ref_name }}

      # ------------------------------------------------------------
      # 6ï¸âƒ£ Generate & Upload Combined SHA256SUMS.txt (after all uploads)
      # ------------------------------------------------------------
      - name: Generate Combined SHA256SUMS.txt
        run: |
          echo "ðŸ”¢ Generating combined SHA256SUMS.txt..."
          VERSION=${{ inputs.version }}
          OUTPUT="toucan-${VERSION}-SHA256SUMS.txt"

          cd packages
          find . -type f \( -name "*.rpm" -o -name "*.deb" -o -name "*.zip" \) -exec sha256sum {} \; > "../${OUTPUT}"
          cd -

          echo "âœ… Combined SHA256SUMS.txt created:"
          cat "${OUTPUT}"

        shell: bash

      - name: Upload Combined SHA256SUMS.txt
        uses: AButler/upload-release-assets@v3.0
        with:
          files: toucan-${{ inputs.version }}-SHA256SUMS.txt
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          release-tag: ${{ github.ref_name }}