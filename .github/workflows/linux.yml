name: Build, Test and Upload Linux Binaries for tag

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      run_rpm:
        required: false
        type: boolean
        default: true
      run_deb:
        required: false
        type: boolean
        default: true
      static_stdlib:
        required: false
        type: boolean
        default: true

jobs:
  precheck:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - id: check
        run: |
          if [[ "${{ inputs.run_rpm }}" == "true" || "${{ inputs.run_deb }}" == "true" ]]; then
            echo "âœ… Packaging enabled"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸš« No packaging format selected"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  build-binaries:
    needs: precheck
    if: needs.precheck.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64]
        #arch: [x86_64, arm64]
    name: Build ${{ matrix.arch }}
    container:
      image: swift:6.0
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          chmod +x ./scripts/packaging/*.sh
          apt-get update
          apt-get install -y curl git clang libcurl4-openssl-dev libssl-dev libatomic1 zip rpm dpkg-dev qemu-user-static

      - name: Build binaries
        run: |
          if [[ "${{ inputs.static_stdlib }}" == "true" ]]; then
            echo "ðŸ”§ Building with static Swift stdlib for ${{ matrix.arch }}"
            swift build -c release -Xswiftc -static-stdlib
          else
            echo "ðŸ”§ Building without static Swift stdlib for ${{ matrix.arch }}"
            swift build -c release
          fi

      - name: Package RPM
        if: inputs.run_rpm
        run: |
          ARCH=${{ matrix.arch == 'arm64' && 'aarch64' || 'x86_64' }}
          ./scripts/packaging/rpm.sh ${{ inputs.version }} $ARCH

      - name: Package DEB
        if: inputs.run_deb
        run: |
          ARCH=${{ matrix.arch == 'arm64' && 'arm64' || 'amd64' }}
          ./scripts/packaging/deb.sh ${{ inputs.version }} $ARCH

      - name: Create Linux ZIP and SHA256
        run: |
          set -e
          ARCH=${{ matrix.arch }}
          VERSION=${{ env.BUILD_VERSION }}

          echo "ðŸ“¦ Creating Linux ZIP for $ARCH (version: ${VERSION:-unknown})"
          mkdir -p build-zip

          for BIN in toucan toucan-generate toucan-init toucan-serve toucan-watch; do
            if [ -f ".build/release/$BIN" ]; then
              cp ".build/release/$BIN" build-zip/
              echo "âœ… Added $BIN"
            else
              echo "âš ï¸ Missing binary: $BIN"
            fi
          done

          echo " Contents of build-zip/"
          ls -lh build-zip

          cd build-zip
          zip -r "../toucan-linux-$ARCH-${VERSION}.zip" ./*
          cd - >/dev/null

          sha256sum "toucan-linux-$ARCH-${VERSION}.zip" > "toucan-linux-$ARCH-${VERSION}.sha256"
          echo "âœ… ZIP + SHA created"

      - name: Upload artifacts for ${{ matrix.arch }}
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts-${{ matrix.arch }}
          retention-days: 1
          path: |
            build-rpm/*
            build-deb/*
            build-zip/*

  test-and-upload:
    runs-on: ubuntu-latest
    needs: build-binaries
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./packages

      - name: Combine SHA256 files
        run: |
          echo "ðŸ§® Combining all checksum files..."
          find packages -name "*.sha256" -exec cat {} + > toucan-${{ inputs.version }}-SHA256SUMS.txt
          echo "âœ… Combined manifest created:"
          cat toucan-${{ inputs.version }}-SHA256SUMS.txt

      - name: Verify structure
        run: find packages

      # --- x86_64 Tests ---
      - name: Test RPM (x86_64)
        if: inputs.run_rpm
        run: |
          if compgen -G "packages/**/toucan-linux-x86_64*.rpm" > /dev/null; then
            echo "ðŸ§ª Testing x86_64 RPM in Fedora..."
            docker run --rm -v "$PWD/packages:/packages" fedora \
              bash -c "dnf install -y /packages/**/toucan-linux-x86_64*.rpm && toucan --version"
          fi

      - name: Test DEB (amd64)
        if: inputs.run_deb
        run: |
          if compgen -G "packages/**/toucan-linux-amd64*.deb" > /dev/null; then
            echo "ðŸ§ª Testing amd64 DEB in Ubuntu..."
            docker run --rm -v "$PWD/packages:/packages" ubuntu \
              bash -c 'apt-get update && apt-get install -y curl && dpkg -i /packages/**/toucan-linux-amd64*.deb || apt-get install -f -y && toucan --version'
          fi

      # --- ARM64 Tests ---
      - name: Test RPM (ARM64)
        if: inputs.run_rpm
        run: |
          if compgen -G "packages/**/toucan-linux-aarch64*.rpm" > /dev/null; then
            echo "ðŸ§ª Testing ARM64 RPM in Fedora (emulated)..."
            docker run --rm --platform linux/arm64/v8 -v "$PWD/packages:/packages" fedora \
              bash -c "dnf install -y /packages/**/toucan-linux-aarch64*.rpm && toucan --version"
          fi

      - name: Test DEB (ARM64)
        if: inputs.run_deb
        run: |
          if compgen -G "packages/**/toucan-linux-arm64*.deb" > /dev/null; then
            echo "ðŸ§ª Testing ARM64 DEB in Ubuntu (emulated)..."
            docker run --rm --platform linux/arm64/v8 -v "$PWD/packages:/packages" ubuntu \
              bash -c 'apt-get update && apt-get install -y curl && dpkg -i /packages/**/toucan-linux-arm64*.deb || apt-get install -f -y && toucan --version'
          fi

      - name: Upload release assets
        uses: AButler/upload-release-assets@v3.0
        with:
          files: |
            packages/**/toucan-linux-*.rpm
            packages/**/toucan-linux-*.deb
            packages/**/toucan-linux-*.zip
            toucan-${{ inputs.version }}-SHA256SUMS.txt
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          release-tag: ${{ github.ref_name }}